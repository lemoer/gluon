<%-
	local ubus = require 'ubus'
	local unistd = require 'posix.unistd'
	local util = require 'gluon.util'
	local uci = require('simple-uci').cursor()

	local hostname = 'localhost'
	local remotes = {}

	local iframe_src = ''

	uci:foreach('gluon-controller', 'remote', function(remote)
		remotes[tonumber(remote.index)] = remote
	end)

	-- TODO: This is dupplicate, but I am currently not able to avoid this...
	function get_session()
		-- returns the session if it exists or return nil.

		local ubus_rpc_session = http:getcookie("ubus_rpc_session")

		if not ubus_rpc_session then
			return nil
		end

		local conn = ubus.connect()
		local session =  conn:call("session", "get", {
			ubus_rpc_session=ubus_rpc_session
		})

		if not session then
			return nil
		end

		return session.values
	end

	local session = get_session()

	http:prepare_content("application/xhtml+xml")

	function build_link(link, name)
		local link_is_active = true
		if #link <= #request then
			for i in pairs(link) do
				if link[i] ~= request[i] then
					link_is_active = false
				end
			end
		else
			link_is_active = false
		end

		local class
		if link_is_active then
			if #link == #request then
				class = 'active'
			else
				class = 'active-light'
			end
		end
		return '<a'
			.. attr('href', url(link))
			.. attr('class', class)
			.. '>' .. name .. '</a>'
	end
-%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, user-scalable=no" />

		<title>Gluon Controller</title>

		<link rel="stylesheet" href="/static/controller.css" type="text/css" />
	</head>
	<body data-node-address="<%| http:getenv('SERVER_ADDR') %>">
		<div class="container">
			<% if session then -%>
			<div class="sidebar">
				<h1>Gluon-Controller</h1>
				<ul class="nav">
					<li><%= build_link({'nodes'}, 'Nodes') %></li>
					<% if scope and scope.remote then -%>
					<li><ul>
						<li>
							<%= build_link({'nodes', scope.remote.nodeid}, scope.remote.name) %>
							<ul class="nav">
								<li><%= build_link({'nodes', scope.remote.nodeid, 'config'}, 'Config Mode') %></li>
								<li><%= build_link({'nodes', scope.remote.nodeid, 'status'}, 'Status Page') %></li>
								<li><%= build_link({'nodes', scope.remote.nodeid, 'map'}, 'Map') %></li>
								<li><%= build_link({'nodes', scope.remote.nodeid, 'stats'}, 'Stats') %></li>
								<li><%= build_link({'nodes', scope.remote.nodeid, 'keepitup'}, 'KeepItUp') %></li>
							</ul>
						</li>
					</ul></li>
					<%- end %>
					<li><%= build_link({'info'}, 'Info') %></li>
					<li><%= build_link({'logout'}, 'Logout') %></li>
				</ul>
			</div>
			<%- end %>
			<%- if (#request > 0) and (request[1] == 'login') then -%>
			<div class="login">
			<%- else -%>
			<div class="content">
			<%- end %>
				<% renderer.render(content, scope, pkg) %>
			</div>
		</div>

	</body>
</html>
