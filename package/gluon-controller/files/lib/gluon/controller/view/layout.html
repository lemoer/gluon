<%-
	local ubus = require 'ubus'
	local unistd = require 'posix.unistd'
	local util = require 'gluon.util'
	local uci = require('simple-uci').cursor()

	local hostname = 'localhost'
	local remotes = {}

	local iframe_src = ''

	uci:foreach('gluon-controller', 'remote', function(remote)
		remotes[tonumber(remote.index)] = remote
	end)

	-- TODO: This is dupplicate, but I am currently not able to avoid this...
	function get_session()
		-- returns the session if it exists or return nil.

		local ubus_rpc_session = http:getcookie("ubus_rpc_session")

		if not ubus_rpc_session then
			return nil
		end

		local conn = ubus.connect()
		local session =  conn:call("session", "get", {
			ubus_rpc_session=ubus_rpc_session
		})

		if not session then
			return nil
		end

		return session.values
	end

	local session = get_session()

	http:prepare_content("application/xhtml+xml")
-%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, user-scalable=no" />

		<title>Gluon Controller</title>

		<link rel="stylesheet" href="/static/controller.css" type="text/css" />
	</head>
	<body data-node-address="<%| http:getenv('SERVER_ADDR') %>">
		<div class="container">
			<% if session then -%>
			<div class="sidebar">
				<h1>Gluon-Controller</h1>
				<div class="remotes">
					<% for nodeid, remote in pairs(remotes) do %>
					<div class="remote">
					<h2><%| remote.name %></h2>
						<a href="<%| url({'nodes', remote.nodeid, 'config'}) %>">Config Mode</a>,
						<a href="<%| url({'nodes', remote.nodeid, 'status'}) %>">Status Page</a>,
						<a href="<%| url({'nodes', remote.nodeid, 'map'}) %>">Map</a>,
						<a href="<%| url({'nodes', remote.nodeid, 'stats'}) %>">Stats</a>,
						<a href="<%| url({'nodes', remote.nodeid, 'keepitup'}) %>">KeepItUp</a>
					</div>
					<% end %>
				</div>
				<a class="manage-nodes" href="<%| url({'nodes'}) %>">Manage Nodes</a>
				<a class="manage-nodes" href="<%| url({'logout'}) %>">Logout</a>
			</div>
			<%- end %>
			<%- if (#request > 0) and (request[1] == 'login') then -%>
			<div class="login">
			<%- else -%>
			<div class="content">
			<%- end %>
				<% renderer.render(content, scope, pkg) %>
			</div>
		</div>

	</body>
</html>
